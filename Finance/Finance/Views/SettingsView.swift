import SwiftUI
import UniformTypeIdentifiers

struct SettingsView: View {
    @Environment(\.dismiss) var dismiss
    @EnvironmentObject var store: TransactionStore
    @AppStorage("isDarkMode") private var isDarkMode = false
    @State private var selectedCurrency: Currency
    @State private var showingAddGoal = false
    @State private var showingShareSheet = false
    @State private var csvString: String = ""
    
    init(store: TransactionStore) {
        _selectedCurrency = State(initialValue: store.settings.currency)
    }
    
    var body: some View {
        NavigationView {
            List {
                // –í–∞–ª—é—Ç–∞
                Section("–í–∞–ª—é—Ç–∞") {
                    Picker("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É", selection: $selectedCurrency) {
                        ForEach(Currency.allCases, id: \.self) { currency in
                            HStack {
                                Text(currency.rawValue)
                                Text(currency.name)
                            }
                            .tag(currency)
                        }
                    }
                    .onChange(of: selectedCurrency) { newValue in
                        store.updateCurrency(newValue)
                    }
                }
                
                // –¢–µ–º–∞
                Section("–í–Ω–µ—à–Ω–∏–π –≤–∏–¥") {
                    Toggle("–¢–µ–º–Ω–∞—è —Ç–µ–º–∞", isOn: $isDarkMode)
                }
                
                // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏
                Section(header: Text("–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏"), footer: Text("–ù–∞–∂–º–∏—Ç–µ +, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ü–µ–ª—å")) {
                    ForEach(store.settings.financialGoals) { goal in
                        GoalRow(goal: goal)
                    }
                    
                    Button(action: { showingAddGoal = true }) {
                        Label("–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å", systemImage: "plus")
                    }
                }
                
                // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                Section("–≠–∫—Å–ø–æ—Ä—Ç") {
                    Button(action: prepareAndShareCSV) {
                        Label("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏", systemImage: "square.and.arrow.up")
                    }
                }
            }
            .navigationTitle("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
            .navigationBarItems(leading: Button("–ó–∞–∫—Ä—ã—Ç—å") { dismiss() })
            .sheet(isPresented: $showingAddGoal) {
                AddGoalView()
            }
            .sheet(isPresented: $showingShareSheet) {
                ShareSheet(items: [generateCSV()])
            }
        }
        .onAppear {
            selectedCurrency = store.settings.currency
        }
    }
    
    private func prepareAndShareCSV() {
        showingShareSheet = true
    }
    
    private func generateCSV() -> URL {
        var csvString = "–î–∞—Ç–∞,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–¢–∏–ø,–°—É–º–º–∞,–ó–∞–º–µ—Ç–∫–∞\n"
        
        for transaction in store.transactions {
            let row = "\(formatDate(transaction.date)),\(transaction.category.name),\(transaction.type),\(transaction.amount),\(transaction.note)\n"
            csvString.append(row)
        }
        
        let fileURL = FileManager.default.temporaryDirectory.appendingPathComponent("transactions.csv")
        try? csvString.write(to: fileURL, atomically: true, encoding: .utf8)
        return fileURL
    }
    
    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateStyle = .short
        return formatter.string(from: date)
    }
}

struct GoalRow: View {
    @EnvironmentObject var store: TransactionStore
    let goal: FinancialGoal
    @State private var showingEditSheet = false
    @State private var showingDeleteAlert = false
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                VStack(alignment: .leading) {
                    Text(goal.name)
                        .font(.headline)
                    Text("–°—Ä–æ–∫: \(formatDate(goal.deadline))")
                        .font(.caption)
                        .foregroundColor(.gray)
                }
                Spacer()
                Menu {
                    Button(action: { showingEditSheet = true }) {
                        Label("–ò–∑–º–µ–Ω–∏—Ç—å", systemImage: "pencil")
                    }
                    Button(role: .destructive, action: { showingDeleteAlert = true }) {
                        Label("–£–¥–∞–ª–∏—Ç—å", systemImage: "trash")
                    }
                } label: {
                    Image(systemName: "ellipsis")
                        .foregroundColor(.gray)
                }
            }
            
            HStack {
                Text("\(Int(goal.progress * 100))%")
                    .font(.caption)
                Spacer()
                Text("\(goal.currentAmount, specifier: "%.0f") / \(goal.targetAmount, specifier: "%.0f")")
                    .font(.caption)
            }
            
            GeometryReader { geometry in
                ZStack(alignment: .leading) {
                    Rectangle()
                        .fill(Color.gray.opacity(0.3))
                        .frame(height: 8)
                        .cornerRadius(4)
                    
                    Rectangle()
                        .fill(goal.progress >= 1 ? Color.green : Color.blue)
                        .frame(width: min(CGFloat(goal.progress) * geometry.size.width, geometry.size.width), height: 8)
                        .cornerRadius(4)
                }
            }
            .frame(height: 8)
            
            if goal.progress >= 1 {
                Text("–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! üéâ")
                    .font(.caption)
                    .foregroundColor(.green)
            }
        }
        .sheet(isPresented: $showingEditSheet) {
            EditGoalView(goal: goal)
        }
        .alert("–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?", isPresented: $showingDeleteAlert) {
            Button("–û—Ç–º–µ–Ω–∞", role: .cancel) { }
            Button("–£–¥–∞–ª–∏—Ç—å", role: .destructive) {
                store.deleteGoal(goal)
            }
        } message: {
            Text("–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å")
        }
    }
    
    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        return formatter.string(from: date)
    }
}

struct EditGoalView: View {
    @Environment(\.dismiss) var dismiss
    @EnvironmentObject var store: TransactionStore
    let goal: FinancialGoal
    
    @State private var name: String
    @State private var targetAmount: String
    @State private var currentAmount: String
    @State private var deadline: Date
    @State private var selectedCategory: Category?
    
    var incomeCategories: [Category] {
        store.categories.filter { $0.type == .income }
    }
    
    init(goal: FinancialGoal) {
        self.goal = goal
        _name = State(initialValue: goal.name)
        _targetAmount = State(initialValue: String(goal.targetAmount))
        _currentAmount = State(initialValue: String(goal.currentAmount))
        _deadline = State(initialValue: goal.deadline)
        _selectedCategory = State(initialValue: goal.category)
    }
    
    var body: some View {
        NavigationView {
            Form {
                TextField("–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏", text: $name)
                TextField("–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞", text: $targetAmount)
                    .keyboardType(.decimalPad)
                TextField("–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞", text: $currentAmount)
                    .keyboardType(.decimalPad)
                DatePicker("–°—Ä–æ–∫", selection: $deadline, displayedComponents: .date)
                
                Picker("–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞", selection: $selectedCategory) {
                    Text("–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏").tag(nil as Category?)
                    ForEach(incomeCategories) { category in
                        Text(category.name).tag(category as Category?)
                    }
                }
            }
            .navigationTitle("–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å")
            .navigationBarItems(
                leading: Button("–û—Ç–º–µ–Ω–∞") { dismiss() },
                trailing: Button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å") {
                    if let targetAmount = Double(targetAmount),
                       let currentAmount = Double(currentAmount),
                       !name.isEmpty {
                        let updatedGoal = FinancialGoal(
                            id: goal.id,
                            name: name,
                            targetAmount: targetAmount,
                            currentAmount: currentAmount,
                            deadline: deadline,
                            category: selectedCategory
                        )
                        store.updateGoal(updatedGoal)
                        dismiss()
                    }
                }
            )
        }
    }
}

struct AddGoalView: View {
    @Environment(\.dismiss) var dismiss
    @EnvironmentObject var store: TransactionStore
    @State private var name = ""
    @State private var targetAmount = ""
    @State private var deadline = Date()
    @State private var selectedCategory: Category?
    
    var incomeCategories: [Category] {
        store.categories.filter { $0.type == .income }
    }
    
    var body: some View {
        NavigationView {
            Form {
                TextField("–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏", text: $name)
                TextField("–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞", text: $targetAmount)
                    .keyboardType(.decimalPad)
                DatePicker("–°—Ä–æ–∫", selection: $deadline, displayedComponents: .date)
                
                Picker("–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞", selection: $selectedCategory) {
                    Text("–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏").tag(nil as Category?)
                    ForEach(incomeCategories) { category in
                        Text(category.name).tag(category as Category?)
                    }
                }
            }
            .navigationTitle("–ù–æ–≤–∞—è —Ü–µ–ª—å")
            .navigationBarItems(
                leading: Button("–û—Ç–º–µ–Ω–∞") { dismiss() },
                trailing: Button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å") {
                    if let amount = Double(targetAmount), !name.isEmpty {
                        let goal = FinancialGoal(
                            name: name,
                            targetAmount: amount,
                            currentAmount: 0,
                            deadline: deadline,
                            category: selectedCategory
                        )
                        store.addGoal(goal)
                        dismiss()
                    }
                }
            )
        }
    }
}

struct ShareSheet: UIViewControllerRepresentable {
    let items: [Any]
    
    func makeUIViewController(context: Context) -> UIActivityViewController {
        UIActivityViewController(activityItems: items, applicationActivities: nil)
    }
    
    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
} 